#!/bin/bash

if [ ! -f /.dockerenv ]; then
   docker exec -it logicmoo bin/$(basename "${BASH_SOURCE[0]}") $*
   return 0 2>/dev/null
   exit 0
fi

DIR0="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

set -o pipefail
export SCREEN_CMD="sudo -u prologmud_server -- screen"

source /opt/logicmoo_workspace/logicmoo_env.sh

export cmd="${1}"
shift 1

if [ "${cmd}" == "" ] || [ "${cmd}" == "--help" ]; then   
   bash -c "cd $DIR0 ; ls --color"
   bash -c "cd $DIR0 ; grep '\# \-\-help' . -r "

# if [ "${cmd}" == "emacs" ]; then sudo -u prologmud_server -- google-chrome "http://localhost:4125"
elif [ "${cmd}" == "attach" ]; then

STUFF="^Mprolog.
call((bfly_set(butterfly),bfly_set(command_args,\"${*}\"),bfly_set(ptty,\"${PTTY}:${TTY}:${PTY}:${PTS}\"))). bfly_start_link(\"${LOCATION}\").
ansi. 
end_of_file.^M"

echo STUFF=$STUFF
( 
  $SCREEN_CMD -S LogicmooServer -p0 -X stuff "${STUFF}"
  $SCREEN_CMD -rx LogicmooServer
)
elif [ -f "$DIR0/${cmd}.sh" ]; then

  bash -c "$DIR0/${cmd}.sh $*" 

else

    export WHICH=`which ${cmd}.sh`
    if ! [[ -z "${WHICH}" ]]; then 
      bash -c "cd $DIR0 && $WHICH $*" 
    else
      bash -c "cd ~ && $cmd $*"
    fi

fi

return 0 2>/dev/null
exit 0

