
<Macro Butterfly $port>
Listen 1$port
<VirtualHost *:1$port>
Include /etc/apache2/conf-available/doc_root_ssl.conf

RewriteCond %{REQUEST_URI} !^/ef/
RewriteCond %{REQUEST_URI} !^/ace
RewriteCond %{REQUEST_URI} !^/filesystem
RewriteCond %{REQUEST_URI} !^/swish/
RewriteCond %{REQUEST_URI} !^/pengine/
RewriteCond %{REQUEST_URI} !^/lps/
RewriteCond %{REQUEST_URI} !^/openid/
RewriteCond %{REQUEST_URI} !^/node_modules/
RewriteCond %{HTTP:UPGRADE} ^WebSocket$   [NC]
RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
RewriteRule .* "ws://localhost:$port%{REQUEST_URI}" [P,L]

RewriteCond %{REQUEST_URI} !^/ef/
RewriteCond %{REQUEST_URI} !^/filesystem
RewriteCond %{REQUEST_URI} !^/users/
RewriteCond %{REQUEST_URI} !^/logicmoo/
RewriteCond %{REQUEST_URI} !^/fav
RewriteCond %{REQUEST_URI} !^/public/
RewriteCond %{REQUEST_URI} !^/tutorial
RewriteCond %{REQUEST_URI} !^/swish/
RewriteCond %{REQUEST_URI} !^/www/
RewriteCond %{REQUEST_URI} !^/pengine/
RewriteCond %{REQUEST_URI} !^/openid/
RewriteCond %{REQUEST_URI} !^/node_modules/
RewriteCond %{REQUEST_URI} !^/lps/
RewriteCond %{REQUEST_URI} !^/icons/
RewriteCond %{REQUEST_URI} !^/home/
RewriteCond %{REQUEST_URI} !^/help/
RewriteCond %{REQUEST_URI} !^/css/
RewriteCond %{REQUEST_URI} !^/admin/
RewriteCond %{REQUEST_URI} !^/ace
RewriteCond %{REQUEST_URI} ^/index.html [OR]
RewriteCond %{REQUEST_URI} ^/static/ [OR]
RewriteCond %{REQUEST_URI} ^$ [OR]
RewriteCond %{REQUEST_URI} ^/$
RewriteRule .* "http://localhost:$port%{REQUEST_URI}" [P,L]

RewriteCond %{REQUEST_URI} !^/ace
RewriteCond %{REQUEST_URI} !^/swish/
RewriteCond %{REQUEST_URI} !^/www/
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_URI} !^$
RewriteCond %{HTTP:UPGRADE} !^WebSocket$
RewriteCond %{HTTP:CONNECTION} !^Upgrade$ [NC]
RewriteCond %{REQUEST_URI} ^/ef/  [OR]
RewriteCond %{REQUEST_URI} ^/public/  [OR]
RewriteCond %{REQUEST_URI} ^/fav(.*)  [OR]
RewriteCond %{REQUEST_URI} ^/xwiki
RewriteRule "^/(.*)" "http://localhost:80%{REQUEST_URI}" [P,L]

RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_URI} !^$
RewriteCond %{REQUEST_URI} !^/ef
RewriteCond %{REQUEST_URI} !^/static
RewriteCond %{REQUEST_URI} !^/xwiki
RewriteCond %{HTTP:UPGRADE} !^WebSocket$
RewriteCond %{HTTP:CONNECTION} !^Upgrade$ [NC]

RewriteCond %{REQUEST_URI} !^/ace
RewriteCond %{REQUEST_URI} ^/swish_config.json [OR]
RewriteCond %{REQUEST_URI} ^/swish [OR]
RewriteCond %{REQUEST_URI} ^/www/ [OR]
RewriteCond %{REQUEST_URI} ^/css [OR]
RewriteCond %{REQUEST_URI} ^/pengine [OR]
RewriteCond %{REQUEST_URI} ^/icons [OR]
RewriteCond %{REQUEST_URI} ^/lps [OR]
RewriteCond %{REQUEST_URI} ^/logicmoo [OR]
RewriteCond %{REQUEST_URI} ^/home [OR]
RewriteCond %{REQUEST_URI} ^/admin [OR]
RewriteCond %{REQUEST_URI} ^/users [OR]
RewriteCond %{REQUEST_URI} ^/admin [OR]
RewriteCond %{REQUEST_URI} ^/help [OR]
RewriteCond %{REQUEST_URI} ^/openid [OR]
RewriteCond %{REQUEST_URI} ^/tutorial [OR]
RewriteCond %{REQUEST_URI} ^/tutorials [OR]
RewriteCond %{REQUEST_URI} ^/node_modules
RewriteRule "^/(.*)" "http://localhost:3020%{REQUEST_URI}" [P,L]

RewriteCond %{REQUEST_URI} ^/ace
RewriteRule "^/(.*)" "http://localhost:4077%{REQUEST_URI}" [P,L]

#ProxyPass /icons http://localhost:3020/icons
#ProxyPass /lps http://localhost:3020/lps
#ProxyPass /ef http://localhost:80/ef
ProxyPassReverse / http://localhost:80
ProxyPassReverse / http://localhost:3020
ProxyPassReverse / http://localhost:$port
ProxyPassReverse / http://localhost:4077

ProxyPass / http://localhost:$port/
</VirtualHost>
</Macro>

Use Butterfly 4100
Use Butterfly 4101
Use Butterfly 4102
Use Butterfly 4104
Use Butterfly 4123
Use Butterfly 4125

Listen 14077
<VirtualHost *:14077>
Include /etc/apache2/conf-available/doc_root_ssl.conf
ProxyPass / http://localhost:4077/
ProxyPassReverse / http://localhost:4077
</VirtualHost>
